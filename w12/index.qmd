---
title: "Week 12: Causal Forests for Heterogeneous Treatment Effects"
subtitle: "*DSAN 5650: Causal Inference for Computational Social Science*<br><span class='subsubtitle'>Summer 2025, Georgetown University</span>"
author: "Jeff Jacobs"
institute: "[`jj1088@georgetown.edu`](mailto:jj1088@georgetown.edu)"
bibliography: "../_DSAN5650.bib"
date: 2025-08-06
date-format: full
lecnum: 12
categories:
  - "Class Sessions"
tbl-cap-location: bottom
crossref:
  fig-title: "Fig"
  title-delim: ". "
format:
  revealjs:
    df-print: kable
    footer: "DSAN 5650 Week 12: {{< var w12.footer >}}"
    output-file: "slides.html"
    html-math-method: mathjax
    scrollable: true
    link-external-icon: true
    link-external-newwindow: true
    echo: true
    code-fold: true
    theme: [default, "../dsan-globals/jjquarto.scss"]
    include-in-header:
      text: "<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css'><link rel='stylesheet' type='text/css' href='https://cdn.jsdelivr.net/gh/dreampulse/computer-modern-web-font@master/fonts.css'>"
    slide-number: true
    simplemenu:
      flat: true
      barhtml:
        header: "<div class='menubar'><span style='position: absolute; left: 8; padding-left: 8px;'><a href='./index.html'>&larr; Return to Notes</a></span><ul class='menu'></ul></div>"
      scale: 0.5
    revealjs-plugins:
      - simplemenu
  html:
    df-print: kable
    output-file: "index.html"
    html-math-method: mathjax
    link-external-icon: true
    link-external-newwindow: true
    echo: true
    code-fold: true
    include-in-header:
      text: "<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css'><link rel='stylesheet' type='text/css' href='https://cdn.jsdelivr.net/gh/dreampulse/computer-modern-web-font@master/fonts.css'>"
---

::: {.content-visible unless-format="revealjs"}

<center>
<a class="h2" href="./slides.html" target="_blank">Open slides in new window &rarr;</a>
</center>

:::

# Schedule {.smaller .crunch-title .crunch-callout .code-90 data-stack-name="Schedule"}

Today's Planned Schedule:

| | Start | End | Topic |
|:- |:- |:- |:- |
| **Lecture** | 6:30pm | 6:45pm | [Final Projects &rarr;](#final-project--end-of-term-things) |
| | 6:45pm | 7:10pm | [Included Variable Bias &rarr;](#does-aging-cause-sadness)
| | 7:10pm | 8:00pm | [Heterogeneous Treatment Effects &rarr;](#heterogeneous-treatment-effects) |
| **Break!** | 8:00pm | 8:10pm | |
| | 8:10pm | 9:00pm | [Causal Forests &rarr;](#causal-forests) |

: {tbl-colwidths="[12,12,12,64]"}

{{< include ../dsan-globals/_globals-tex.qmd >}}

## Final Project / End of Term Things

* **Midterm** grading will be done TONIGHT
* **Submit button** for HW3 / HW4 TONIGHT

## Sensitivity Analysis {.smaller .crunch-title}

* So you've got an estimate of a causal effect! What now? Two possible next steps...
* <i class='bi bi-1-circle'></i> **Sensitivity Analysis**: Check **robustness** of your results
  * Modeling choices &rarr; **one point** in param space (*garden of forking paths*)
  * If results "truly" hold, shouldn't disappear with small changes in parameters/choices
  * *Last week*: Can re-estimate with **informative** &rarr; **weak** &rarr; **skeptical** priors
  * *This week*: Simulate **how "strong"** omissions would have to be to **"ruin" finding**
* <i class='bi bi-2-circle'></i> **Heterogeneous Treatment Effects**: How does the effect **vary** btwn subgroups?
  * Example today: PROGRESA (Cash transfer poverty-alleviation program in Mexico)
  * Program has an **overall** causal effect, but also a **greater** causal effect on **indigenous** households, relative to non-indigenous
  * How can we find group-specific effects? **Causal forests!**

# Sensitivity Analysis 2: How Sensitive Are My Results to *Omitted/Included Variable Bias*? {.smaller .title-10 .crunch-title data-stack-name="Included Variable Bias"}

* You probably know about **omitted variable bias** from previous classes / intuition... but, **included variable bias?**
* That's right folks... **colliders** can be agents of chaos, laying waste to our best, most meticulously-planned-out models

![](images/mood_crop.jpg){fig-align="center"}

## Does Aging Cause Sadness? {.smaller .crunch-title .title-11 .crunch-ul .crunch-quarto-figure .table-80 .crunch-img .crunch-quarto-layout-panel .crunch-quarto-layout-cell .crunch-figure .crunch-figcaption .inline-70 .crunch-p}

{{< include ../_components/age-happy-plot.qmd >}}

## Assessing the Impact of Omitted / Included Vars {.smaller .crunch-title}

* Working example from @cinelli_making_2020: what is the **causal impact** of **experiencing violence** on **support for a peace deal**
* Researcher A models this scenario as:

$$
PeaceIndex = \tau^{\text{res}} DirectHarm + \beta^ resFemale+Villageβˆv,res+Xβˆres+"ˆres
$$

* Researcher B instead prefers:

$$
PeaceIndex=τˆDirectHarm+βˆfFemale+Villageβˆv+Xβˆ+γˆCenter+"ˆfull,
$$

> Our earlier estimate $\tau^{\text{res}}$ would differ from our target quantity $\tau$: but how badly? [...] How strong would the confounder(s) have to be to change the estimates in such a way to affect the main conclusions of a study?

## The Classical OVB Equation {.smaller .crunch-title .title-12 .crunch-ul .crunch-math .footnotes-0 .math-90 .inline-90}

* Remember that $D$ is our **treatment** variable! ($\mathbf{X}$ = covariates, $Y$ = outcome)
* In a perfect world, we would estimate $Y = \hat{\tau}D + \mathbf{X} \hat{\beta} + \hat{\gamma}Z+ \varepsilon_{\text{full}}$
* But, $Z$ is **unobserved** $\leadsto$ **"restricted"** model $Y = \hat{\tau}_{\text{res}}D + \mathbf{X} \hat{\beta}_{\text{res}} + \varepsilon_{\text{res}}$
* What is the "gap" between $\hat{\tau}$ and $\hat{\tau}^{\text{res}}$? $\text{OVB} = \hat{\tau}_{\text{res}} - \hat{\tau}$

:::: {.columns}
::: {.column width="40%"}

$$
\begin{align*}
\hat{\tau}_{\text{res}} &= \frac{
  \text{Cov}[D^{\top \mathbf{X}}, Y^{\top \mathbf{X}}]
}{
  \text{Var}[D^{\top \mathbf{X}}]
} \\
&= \frac{
  \text{Cov}[D^{\top \mathbf{X}}, \hat{\tau}D^{\top \mathbf{X}} + \hat{\gamma}Z^{\top \mathbf{X}}]
}{
  \text{Var}[D^{\top \mathbf{X}}]
} \\
&= \hat{\tau} + \hat{\gamma}\frac{
  \text{Cov}[D^{\top \mathbf{X}}, Z^{\top \mathbf{X}}]
}{
  \text{Var}[D^{\top \mathbf{X}}]
} \\
&= \hat{\tau} + \hat{\gamma}\hat{\delta} \\
\implies \text{OVB} &= \hat{\tau}_{\text{res}} - \hat{\tau} = \overbrace{
  \boxed{\hat{\gamma} \times \hat{\delta}}
}^{\mathclap{\text{Impact} \, \times \, \text{Imbalance}}}
\end{align*}
$$

:::
::: {.column width="60%"}

![](images/sensitivity.svg){fig-align="center" width="360"}

:::
::::

::: {.aside}

The ability to produce **orthogonalized** ($\top \mathbf{X}$) versions of vars in the model utilizes the [Frisch-Waugh-Lovell Theorem](https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem)

:::

## More Generally

* What if we don't have a **specific** omitted variable in mind? We just want to know the expected impact **if** there were omitted vars... Enter "Partial $R^2$"

:::: {.columns}
::: {.column width="50%"}

![](images/r2.svg){fig-align="center"}

:::
::: {.column width="50%"}

![](images/r2_extreme.svg){fig-align="center"}

:::
::::

# Heterogeneous Treatment Effects {data-stack-name="HTEs"}

## PROGRESA

## References

::: {#refs}
:::
